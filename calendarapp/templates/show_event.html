{% extends "layouts/base-fullscreen-new.html" %}

{% block content %}

<style>
    td.available-dates {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        /* Adds spacing between badges */
    }

    .badge {
        white-space: nowrap;
        /* Ensures each date stays in a single line */
    }
</style>

<div class="container mt-5">
    <!-- Event Details -->
    <div class="card shadow-lg">
        <div class="card-header bg-white text-primary">
            <h2 class="mb-0">{{ event.name }}</h2>
            <p class="mb-0">Hosted by: {{ event.email }}</p>
        </div>
        <div class="card-body">
            <p><strong>Start Date:</strong> {{ event.start_date|date:"F j, Y" }}</p>
            <p><strong>End Date:</strong> {{ event.end_date|date:"F j, Y" }}</p>
            <p><strong>Event ID:</strong>
                <span id="access-code">{{ event.access_code }}</span>
                <br>
                <button class="btn btn-outline-primary" onclick="copyEventUrl(this)"
                    data-url="{{ request.build_absolute_uri }}">Copy URL</button>
            </p>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="card mt-4 shadow">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">Event Calendar</h4>
        </div>
        <div class="card-body">
            <div id="calendar" style="max-width: 900px; margin: 0 auto;"></div>
        </div>
    </div>

    <!-- Guest Availability -->
    <div class="card mt-4 shadow">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">Guest Availability</h4>
        </div>
        <div class="mt-4 text-center">
            {% if event.end_date >= today %}
            <a href="{% url 'add_availability' event.access_code %}" class="btn btn-primary">Add Your Availability</a>
            {% else %}
            <p class="text-danger">Sorry, this event has already ended.</p>
            {% endif %}
        </div>
        <div class="card-body">
            <p>Here you can see which dates your guests are available.</p>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Guest Name</th>
                        <th>Available Dates</th>
                    </tr>
                </thead>
                <tbody>
                    {% for guest in event.guestavailability_set.all %}
                    <tr>
                        <td>{{ guest.name }}</td>
                        <td class="available-dates">
                            {% for date in guest.availabledate_set.all|dictsort:"date" %}
                            <span class="badge bg-success">{{ date.date|date:"F j, Y" }}</span>
                            {% endfor %}
                        </td>

                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center">No guest availability submitted yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- FullCalendar Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css" />

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const availabilityData = JSON.parse('{{ availability_data|safe }}');

        let events = [];
        let highlightRanges = [];

        // Convert event end date to JavaScript date and add one day to make sure it's included
        let eventEndDate = new Date('{{ event.end_date|date:"Y-m-d" }}');
        eventEndDate.setDate(eventEndDate.getDate() + 1); // Add 1 day to make it inclusive

        // Highlight the entire event duration INCLUDING the end date
        highlightRanges.push({
            start: '{{ event.start_date|date:"Y-m-d" }}',
            end: eventEndDate.toISOString().split('T')[0], // Convert back to string
            display: 'background',
            color: '#ffeeba'
        });

        // Convert availability data into separate FullCalendar events per guest
        for (const [date, guests] of Object.entries(availabilityData)) {
            guests.forEach(guest => {
                events.push({
                    title: guest, // Each guest as a separate event
                    start: date,
                    color: '#007bff',
                    textColor: '#ffffff'
                });
            });
        }

        // Add event start and end markers
        events.push(
            {
                title: 'Start Date',
                start: '{{ event.start_date|date:"Y-m-d" }}',
                color: '#28a745',
                textColor: '#ffffff'
            },
            {
                title: 'End Date',
                start: '{{ event.end_date|date:"Y-m-d" }}',
                color: '#dc3545',
                textColor: '#ffffff'
            }
        );

        // Initialize FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            eventDisplay: 'block',
            events: events.concat(highlightRanges) // Merge availability events and highlight range
        });

        calendar.render();
    });
</script>


{% endblock content %}